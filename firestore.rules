rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function userDocPath(uid) {
      return /databases/$(database)/documents/usuarios/$(uid);
    }

    function authUserExists() {
      return isSignedIn() && exists(userDocPath(request.auth.uid));
    }

    function authRole() {
      return authUserExists() ? get(userDocPath(request.auth.uid)).data.rol : null;
    }

    function isAgente() {
      return authRole() == 'agente' || authRole() == 'admin';
    }

    function isAdmin() {
      return authRole() == 'admin';
    }

    function isPantalla() {
      return authRole() == 'pantalla';
    }

    match /usuarios/{userId} {
      allow create, get, update: if isSignedIn() && request.auth.uid == userId;
      allow list, get, update: if isAdmin();
      allow delete: if false;
    }

    match /tramites/{tramiteId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /feriados/{feriadoId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /slotLocks/{lockId} {
      allow read, write: if false;
    }

    match /citas/{citaId} {
      allow create: if false; // Se agenda solo por Cloud Function (agendarCitaWebLock)
      allow delete: if isSignedIn() && resource.data.userID == request.auth.uid;
      allow update: if isAgente();
      allow read: if isAgente() || (isSignedIn() && resource.data.userID == request.auth.uid);
    }

    match /turnos/{turnoId} {
      allow create: if true;
      allow get: if true;
      allow list: if isAgente();
      allow update: if isAgente();
      allow delete: if false;
    }

    match /estadoSistema/{docId} {
      allow read: if true;
      allow write: if isAgente();
    }

    // NUEVO: Configuración Pantalla TV (publicidad)
    match /config/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /ciudadanos/{docId} {
      allow read: if isAgente() || isPantalla() || isAdmin();
      allow create, update, delete: if isAgente();
    }

    // Bitácora / auditoría de atenciones (solo lectura desde clientes autorizados)
    match /serviceAudit/{docId} {
      allow read: if isAgente() || isAdmin();
      allow create, update, delete: if false;
    }

  }
}
